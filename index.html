<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KoshpaGram</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <style>
    :root { --bg:#17212b; --sec:#232e39; --blue:#2481cc; --text:#fff; --muted:#8696a8; --green:#4fad66; }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { height:100vh; background:#000; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; overflow:hidden; color:var(--text); }
    #authScreen, #app { width:100%; height:100%; display:flex; }
    #authScreen { background:linear-gradient(135deg,#667eea,#764ba2); align-items:center; justify-content:center; }
    .auth-box { background:rgba(255,255,255,0.1); backdrop-filter:blur(12px); padding:40px; border-radius:20px; width:380px; text-align:center; }
    .auth-box h1::before { content:"Cat "; }
    .auth-box input, .auth-box select { width:100%; padding:14px; margin:10px 0; border:none; border-radius:12px; background:rgba(255,255,255,0.2); color:white; }
    .auth-box button { width:100%; padding:14px; background:white; color:#764ba2; border:none; border-radius:12px; font-weight:bold; margin-top:15px; cursor:pointer; }
    #app { display:none; background:var(--bg); }
    #sidebar { width:320px; background:var(--sec); border-right:1px solid #2b5278; display:flex; flex-direction:column; }
    .header { height:65px; background:var(--blue); padding:0 20px; display:flex; align-items:center; justify-content:space-between; font-size:20px; font-weight:600; }
    .header::before { content:"Cat "; }
    .add-contact { background:rgba(255,255,255,0.1); padding:10px; border-radius:8px; margin:10px; text-align:center; cursor:pointer; }
    #chatList { flex:1; overflow-y:auto; }
    .chat-item { padding:14px 16px; display:flex; align-items:center; cursor:pointer; transition:0.2s; }
    .chat-item:hover, .chat-item.active { background:#2b5278; }
    .chat-avatar { width:50px; height:50px; border-radius:50%; background:#ff6b6b; display:flex; align-items:center; justify-content:center; font-size:26px; margin-right:12px; }
    .chat-info { flex:1; }
    .chat-name { font-weight:600; }
    .chat-last { font-size:13px; color:var(--muted); margin-top:3px; }
    .typing { font-size:12px; color:var(--green); font-style:italic; }

    #main { flex:1; display:flex; flex-direction:column; background:#0e1621; }
    #chatHeader { height:65px; background:var(--sec); padding:0 20px; display:flex; align-items:center; gap:12px; border-bottom:1px solid #2b3744; }
    #messages { flex:1; overflow-y:auto; padding:20px; }
    .message { max-width:70%; margin-bottom:16px; padding:10px 14px; border-radius:12px; word-wrap:break-word; }
    .message.mine { background:var(--blue); color:white; margin-left:auto; border-bottom-right-radius:4px; }
    .message.other { background:#2b3744; border-bottom-left-radius:4px; }
    .message .name { font-size:12px; opacity:0.8; margin-bottom:4px; }
    .message .time { font-size:11px; opacity:0.7; text-align:right; margin-top:4px; }
    #inputArea { padding:12px; background:var(--sec); display:flex; gap:10px; }
    #inputArea input { flex:1; padding:12px 18px; background:#2e3a46; border:none; border-radius:20px; color:white; }
    #inputArea button { width:46px; height:46px; background:var(--blue); border:none; border-radius:50%; color:white; font-size:20px; cursor:pointer; }
  </style>
</head>
<body>

<!-- Авторизация -->
<div id="authScreen">
  <div class="auth-box">
    <h1>KoshpaGram</h1>
    <p>Вход или регистрация</p>
    <input type="text" id="phone" placeholder="+79161234567" value="+79161234567">
    <input type="text" id="name" placeholder="Имя" value="Бебрик">
    <input type="password" id="password" placeholder="Пароль (мин. 6 символов)" value="123456">
    <select id="avatar">
      <option value="Cat">Котик</option>
      <option value="Grinning Cat">Улыбающийся кот</option>
      <option value="Black Cat">Чёрный кот</option>
      <option value="Paw">Лапки</option>
    </select>
    <button onclick="login()">Войти</button>
  </div>
</div>

<!-- Приложение -->
<div id="app">
  <div id="sidebar">
    <div class="header">
      <div>KoshpaGram</div>
      <div class="add-contact" onclick="addContact()">+ Добавить контакт</div>
    </div>
    <div id="chatList">
      <div class="chat-item active" data-chat="global">
        <div class="chat-avatar">Cat</div>
        <div class="chat-info">
          <div class="chat-name">Общий чат</div>
          <div class="chat-last">нажми, чтобы открыть</div>
        </div>
      </div>
    </div>
  </div>

  <div id="main">
    <div id="chatHeader">
      <div class="chat-avatar" id="currentAvatar">Cat</div>
      <div>
        <div class="chat-name" id="currentTitle">Общий чат</div>
        <div class="typing" id="typingIndicator"></div>
      </div>
    </div>
    <div id="messages"></div>
    <div id="inputArea">
      <input type="text" id="messageInput" placeholder="Сообщение..." oninput="sendTyping()">
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>
</div>

<script>
  // ТВОЙ КОНФИГ — РАБОЧИЙ!
  const firebaseConfig = {
    apiKey: "AIzaSyDvRKmyltuxYuvmGPWr7Agu_ExLr8OudrY",
    authDomain: "koshpagram.firebaseapp.com",
    databaseURL: "https://koshpagram-default-rtdb.firebaseio.com",
    projectId: "koshpagram",
    storageBucket: "koshpagram.firebasestorage.app",
    messagingSenderId: "631435567718",
    appId: "1:631435567718:web:c2d71024479a93c40983a7"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  let currentUser = null;
  let currentChatId = 'global';
  let typingTimer = null;

  // === АВТОРИЗАЦИЯ ===
  function login() {
    const phone = document.getElementById('phone').value.trim();
    const name = document.getElementById('name').value.trim() || 'Котик';
    const pass = document.getElementById('password').value;
    const avatar = document.getElementById('avatar').value;

    if (pass.length < 6) return alert('Пароль минимум 6 символов');

    const email = phone.replace(/[^\d+]/g,'') + '@koshpagram.app';

    auth.signInWithEmailAndPassword(email, pass)
      .catch(() => auth.createUserWithEmailAndPassword(email, pass))
      .then(cred => {
        currentUser = cred.user;
        db.ref('users/' + currentUser.uid).set({ name, phone, avatar, online: true, lastSeen: Date.now() });
        startApp();
      })
      .catch(e => alert(e.message));
  }

  function startApp() {
    document.getElementById('authScreen').style.display = 'none';
    document.getElementById('app').style.display = 'flex';
    loadChats();
    openChat('global');
  }

  // === ЧАТЫ ===
  function loadChats() {
    const list = document.getElementById('chatList');
    list.innerHTML = '<div class="chat-item active" data-chat="global"><div class="chat-avatar">Cat</div><div class="chat-info"><div class="chat-name">Общий чат</div></div></div>';

    db.ref('users').on('value', snap => {
      snap.forEach(userSnap => {
        const user = userSnap.val();
        if (userSnap.key !== currentUser.uid) {
          const chatId = [currentUser.uid, userSnap.key].sort().join('_');
          if (!document.querySelector(`[data-chat="${chatId}"]`)) {
            const div = document.createElement('div');
            div.className = 'chat-item';
            div.dataset.chat = chatId;
            div.innerHTML = `<div class="chat-avatar">${user.avatar}</div><div class="chat-info"><div class="chat-name">${user.name}</div><div class="chat-last">личный чат</div></div>`;
            div.onclick = () => openChat(chatId, user.name, user.avatar);
            list.appendChild(div);
          }
        }
      });
    });
  }

  function addContact() {
    const phone = prompt('Введи номер друга (например +79161234567):');
    if (!phone) return;
    const cleanPhone = phone.replace(/[^\d+]/g,'');
    db.ref('users').orderByChild('phone').equalTo(cleanPhone).once('value', snap => {
      if (snap.val()) {
        snap.forEach(u => {
          const uid = u.key;
          const data = u.val();
          const chatId = [currentUser.uid, uid].sort().join('_');
          openChat(chatId, data.name, data.avatar);
        });
      } else {
        alert('Такого котика ещё нет в KoshpaGram');
      }
    });
  }

  function openChat(chatId, title = 'Общий чат', avatar = 'Cat') {
    currentChatId = chatId;
    document.querySelectorAll('.chat-item').forEach(i => i.classList.remove('active'));
    document.querySelector(`[data-chat="${chatId}"]`)?.classList.add('active');
    document.getElementById('currentTitle').textContent = title;
    document.getElementById('currentAvatar').textContent = avatar;
    document.getElementById('messages').innerHTML = '';
    document.getElementById('typingIndicator').textContent = '';

    const ref = chatId === 'global' ? db.ref('global_messages') : db.ref('private_messages/' + chatId);
    ref.off();
    ref.orderByChild('time').limitToLast(100).on('child_added', snap => {
      const msg = snap.val();
      db.ref('users/' + msg.uid).once('value').then(u => {
        const user = u.val();
        addMessage(msg.text, msg.uid === currentUser.uid, user?.name || 'Кот', user?.avatar || 'Cat', msg.time);
      });
    });

    // Статус "печатает..."
    if (chatId !== 'global') {
      const otherUid = chatId.split('_').find(id => id !== currentUser.uid);
      db.ref('typing/' + chatId + '/' + otherUid).on('value', snap => {
        document.getElementById('typingIndicator').textContent = snap.val() ? 'печатает...' : '';
      });
    }
  }

  function addMessage(text, isMine, name, avatar, time) {
    const div = document.createElement('div');
    div.className = `message ${isMine ? 'mine' : 'other'}`;
    const t = new Date(time).toLocaleTimeString('ru', {hour:'2-digit', minute:'2-digit'});
    div.innerHTML = `${!isMine ? `<div class="name">${avatar} ${name}</div>` : ''}${text}<div class="time">${t}</div>`;
    document.getElementById('messages').appendChild(div);
    div.scrollIntoView({behavior:'smooth'});
  }

  function sendMessage() {
    const input = document.getElementById('messageInput');
    const text = input.value.trim();
    if (!text) return;
    const msg = { uid: currentUser.uid, text, time: Date.now() };

    if (currentChatId === 'global') {
      db.ref('global_messages').push(msg);
    } else {
      db.ref('private_messages/' + currentChatId).push(msg);
    }
    input.value = '';
    clearTimeout(typingTimer);
    db.ref('typing/' + currentChatId + '/' + currentUser.uid).remove();
  }

  function sendTyping() {
    if (currentChatId === 'global') return;
    clearTimeout(typingTimer);
    db.ref('typing/' + currentChatId + '/' + currentUser.uid).set(true);
    typingTimer = setTimeout(() => {
      db.ref('typing/' + currentChatId + '/' + currentUser.uid).remove();
    }, 1000);
  }

  document.getElementById('messageInput').addEventListener('keypress', e => {
    if (e.key === 'Enter') sendMessage();
  });

  // Автовход
  auth.onAuthStateChanged(user => {
    if (user && !currentUser) {
      currentUser = user;
      startApp();
    }
  });
</script>
</body>
</html>
