<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KoshpaGram</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <style>
    :root {
      --tg-bg: #17212b;
      --tg-sec: #232e39;
      --tg-blue: #2481cc;
      --tg-text: #fff;
      --tg-muted: #8696a8;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { height:100vh; background:#000; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; overflow:hidden; }
    #authScreen, #app { width:100%; height:100%; display:flex; }
    #authScreen { background: linear-gradient(135deg, #667eea, #764ba2); align-items:center; justify-content:center; color:white; }
    .auth-box {
      background:rgba(255,255,255,0.1); backdrop-filter:blur(10px); padding:40px; border-radius:20px; width:380px; text-align:center; box-shadow:0 20px 40px rgba(0,0,0,0.3);
    }
    .auth-box h1 { font-size:32px; margin-bottom:10px; }
    .auth-box h1::before { content:"üê± "; }
    .auth-box input, .auth-box select {
      width:100%; padding:14px; margin:12px 0; border:none; border-radius:12px; background:rgba(255,255,255,0.2); color:white; font-size:16px;
    }
    .auth-box input::placeholder { color:#ddd; }
    .auth-box button {
      width:100%; padding:14px; background:#fff; color:#764ba2; border:none; border-radius:12px; font-size:18px; font-weight:bold; cursor:pointer; margin-top:20px;
    }
    .error { color: #ff6b6b; margin-top:10px; font-size:14px; }
    #app { display:none; background:var(--tg-bg); color:var(--tg-text); }
    #sidebar { width:320px; background:var(--tg-sec); border-right:1px solid #2b5278; display:flex; flex-direction:column; }
    .header { height:65px; background:var(--tg-blue); padding:0 20px; display:flex; align-items:center; font-size:20px; font-weight:600; }
    .header::before { content:"üê± "; }
    #chatList { flex:1; overflow-y:auto; }
    .chat-item {
      padding:14px 16px; display:flex; align-items:center; cursor:pointer; transition:0.2s;
    }
    .chat-item:hover { background:#2b5278; }
    .chat-item.active { background:#2c5278; }
    .avatar {
      width:50px; height:50px; border-radius:50%; background:#ff6b6b; display:flex; align-items:center; justify-content:center; font-size:24px; margin-right:12px;
    }
    .chat-name { font-weight:600; }
    .preview { font-size:13px; color:var(--tg-muted); margin-top:4px; }
    #main { flex:1; display:flex; flex-direction:column; background:#0e1621; }
    #chatHeader { height:65px; background:var(--tg-sec); padding:0 20px; display:flex; align-items:center; gap:12px; border-bottom:1px solid #2b3744; }
    #messages { flex:1; overflow-y:auto; padding:20px; }
    .message {
      max-width:70%; margin-bottom:16px; padding:10px 14px; border-radius:12px; position:relative; word-wrap:break-word;
    }
    .message.mine { background:var(--tg-blue); color:white; margin-left:auto; border-bottom-right-radius:4px; }
    .message.other { background:#2b3744; color:white; border-bottom-left-radius:4px; }
    .message .name { font-size:12px; opacity:0.8; margin-bottom:4px; }
    .message .time { font-size:11px; opacity:0.7; text-align:right; margin-top:4px; }
    #inputArea {
      padding:12px; background:var(--tg-sec); display:flex; gap:10px;
    }
    #inputArea input {
      flex:1; padding:12px 18px; background:#2e3a46; border:none; border-radius:20px; color:white; font-size:15px;
    }
    #inputArea button {
      width:46px; height:46px; background:var(--tg-blue); border:none; border-radius:50%; color:white; font-size:20px; cursor:pointer;
    }
  </style>
</head>
<body>

<!-- –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
<div id="authScreen">
  <div class="auth-box">
    <h1>KoshpaGram</h1>
    <p>–í—Ö–æ–¥ –∏–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (–¥–ª—è —Ç–µ—Å—Ç–∞: +79161234567 / 123456)</p>
    
    <input type="text" id="phone" placeholder="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (+7916...)" maxlength="16">
    <input type="text" id="name" placeholder="–¢–≤–æ—ë –∏–º—è">
    <input type="date" id="birthdate" placeholder="–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è">
    <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤)">
    <select id="avatar">
      <option value="üê±">–ö–æ—Ç–∏–∫</option>
      <option value="üò∫">–£–ª—ã–±–∞—é—â–∏–π—Å—è –∫–æ—Ç</option>
      <option value="üêà">–ß—ë—Ä–Ω—ã–π –∫–æ—Ç</option>
      <option value="üêæ">–õ–∞–ø–∫–∏</option>
      <option value="ü¶Å">–õ–µ–≤</option>
      <option value="üêØ">–¢–∏–≥—Ä</option>
    </select>
    
    <button onclick="loginOrRegister()">–í–æ–π—Ç–∏ –≤ KoshpaGram</button>
    <div id="errorMsg" class="error" style="display:none;"></div>
  </div>
</div>

<!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
<div id="app">
  <div id="sidebar">
    <div class="header">KoshpaGram</div>
    <div id="chatList">
      <div class="chat-item active" onclick="openChat('global')">
        <div class="avatar">üê±</div>
        <div>
          <div class="chat-name">–û–±—â–∏–π –∫–æ—à–∞—á–∏–π —á–∞—Ç</div>
          <div class="preview">–º—è—è—è–≤, –∫—Ç–æ-—Ç–æ –Ω–∞–ø–∏—Å–∞–ª...</div>
        </div>
      </div>
    </div>
  </div>

  <div id="main">
    <div id="chatHeader">
      <div class="avatar" id="chatAvatar">üê±</div>
      <div>
        <div class="chat-name">–û–±—â–∏–π –∫–æ—à–∞—á–∏–π —á–∞—Ç</div>
        <div style="color:#4fad66; font-size:13px;">–º–Ω–æ–≥–æ –∫–æ—Ç–∏–∫–æ–≤ –æ–Ω–ª–∞–π–Ω</div>
      </div>
    </div>
    <div id="messages"></div>
    <div id="inputArea">
      <input type="text" id="messageInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
      <button onclick="sendMessage()">‚û¶</button>
    </div>
  </div>
</div>

<script>
  // ‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê –í–°–¢–ê–í–¨ –°–í–û–ô –ö–û–ù–§–ò–ì FIREBASE –ó–î–ï–°–¨ ‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê
  const firebaseConfig = {
    apiKey: "AIzaSyBxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
    authDomain: "koshpagram.firebaseapp.com",
    databaseURL: "https://koshpagram-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "koshpagram",
    storageBucket: "koshpagram.appspot.com",
    messagingSenderId: "1234567890",
    appId: "1:1234567890:web:abcdef1234567890"
  };
  // ‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  let currentUser = null;

  // –§—É–Ω–∫—Ü–∏—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–æ–º–µ—Ä–∞
  function normalizePhone(phone) {
    return phone.replace(/[\s\-\(\)]/g, ''); // –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã, –¥–µ—Ñ–∏—Å—ã, —Å–∫–æ–±–∫–∏
  }

  // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏–ª–∏ –≤—Ö–æ–¥
  function loginOrRegister() {
    const phoneRaw = document.getElementById('phone').value.trim();
    const name = document.getElementById('name').value.trim();
    const birthdate = document.getElementById('birthdate').value;
    const password = document.getElementById('password').value;
    const avatar = document.getElementById('avatar').value;
    const errorMsg = document.getElementById('errorMsg');

    // –û—á–∏—Å—Ç–∫–∞ –æ—à–∏–±–æ–∫
    errorMsg.style.display = 'none';
    errorMsg.textContent = '';

    // –í–∞–ª–∏–¥–∞—Ü–∏—è
    if (!phoneRaw || !phoneRaw.startsWith('+')) {
      showError('–ù–æ–º–µ—Ä –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å + (–Ω–∞–ø—Ä–∏–º–µ—Ä: +79161234567)');
      return;
    }
    const phone = normalizePhone(phoneRaw);
    if (phone.length < 10) {
      showError('–ù–æ–º–µ—Ä —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π! –ú–∏–Ω–∏–º—É–º 10 —Ü–∏—Ñ—Ä –ø–æ—Å–ª–µ +');
      return;
    }
    if (!name) {
      showError('–í–≤–µ–¥–∏—Ç–µ –∏–º—è!');
      return;
    }
    if (!birthdate) {
      showError('–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è!');
      return;
    }
    if (password.length < 6) {
      showError('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤!');
      return;
    }

    const fakeEmail = phone + '@koshpagram.app'; // –ò–∑–º–µ–Ω–∏–ª –¥–æ–º–µ–Ω –Ω–∞ .app (–ª—É—á—à–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)

    auth.signInWithEmailAndPassword(fakeEmail, password)
      .then(cred => {
        currentUser = cred.user;
        return db.ref('users/' + currentUser.uid).once('value');
      })
      .catch(() => { // –ï—Å–ª–∏ –≤—Ö–æ–¥ –Ω–µ —É–¥–∞–ª—Å—è ‚Äî –ø—Ä–æ–±—É–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
        return auth.createUserWithEmailAndPassword(fakeEmail, password)
          .then(cred => {
            currentUser = cred.user;
            return db.ref('users/' + currentUser.uid).set({
              name, phone, birthdate, avatar, online: true, lastSeen: Date.now()
            });
          });
      })
      .then(() => {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –±–∞–∑—É, –µ—Å–ª–∏ –µ—â—ë –Ω–µ
        if (!currentUser.displayName) {
          currentUser.updateProfile({ displayName: name });
        }
        document.getElementById('authScreen').style.display = 'none';
        document.getElementById('app').style.display = 'flex';
        document.getElementById('chatAvatar').textContent = avatar;
        loadMessages();
      })
      .catch(err => {
        console.error(err); // –î–ª—è –¥–µ–±–∞–≥–∞
        let message = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
        switch (err.code) {
          case 'auth/invalid-email': message = '–ù–µ–≤–µ—Ä–Ω—ã–π email (–ø—Ä–æ–≤–µ—Ä—å –Ω–æ–º–µ—Ä)'; break;
          case 'auth/user-not-found': message = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –ø–æ–ø—Ä–æ–±—É–π –¥—Ä—É–≥–æ–π –Ω–æ–º–µ—Ä'; break;
          case 'auth/wrong-password': message = '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å'; break;
          case 'auth/email-already-in-use': message = '–ê–∫–∫–∞—É–Ω—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π —ç—Ç–æ—Ç –Ω–æ–º–µ—Ä –∏ –ø–∞—Ä–æ–ª—å'; break;
          case 'auth/weak-password': message = '–ü–∞—Ä–æ–ª—å —Å–ª–∏—à–∫–æ–º —Å–ª–∞–±—ã–π (–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤)'; break;
          case 'auth/network-request-failed': message = '–ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é ‚Äî –ø—Ä–æ–≤–µ—Ä—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç'; break;
          default: message = err.message;
        }
        showError(message);
      });
  }

  function showError(msg) {
    const errorMsg = document.getElementById('errorMsg');
    errorMsg.textContent = msg;
    errorMsg.style.display = 'block';
  }

  // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
  function sendMessage() {
    const input = document.getElementById('messageInput');
    const text = input.value.trim();
    if (!text || !currentUser) return;

    db.ref('global_messages').push({
      uid: currentUser.uid,
      name: currentUser.displayName || "–ö–æ—Ç–∏–∫",
      text: text,
      avatar: "üê±",
      time: Date.now()
    });
    input.value = '';
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
  function loadMessages() {
    db.ref('global_messages').orderByChild('time').limitToLast(100).on('child_added', snap => {
      const msg = snap.val();
      if (!msg.uid) return;

      db.ref('users/' + msg.uid).once('value').then(userSnap => {
        const user = userSnap.val() || { name: "–£–¥–∞–ª—ë–Ω–Ω—ã–π –∫–æ—Ç", avatar: "üòø" };
        addMessage({ ...msg, name: user.name, avatar: user.avatar || "üê±" });
      });
    });
  }

  function addMessage(msg) {
    const isMine = msg.uid === currentUser.uid;
    const div = document.createElement('div');
    div.className = `message ${isMine ? 'mine' : 'other'}`;
    const time = new Date(msg.time).toLocaleTimeString('ru', {hour:'2-digit', minute:'2-digit'});

    div.innerHTML = `
      ${!isMine ? `<div class="name">${msg.avatar} ${msg.name}</div>` : ''}
      ${msg.text}
      <div class="time">${time}</div>
    `;
    document.getElementById('messages').appendChild(div);
    div.scrollIntoView({behavior: 'smooth'});
  }

  // Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
  document.getElementById('messageInput').addEventListener('keypress', e => {
    if (e.key === 'Enter') sendMessage();
  });

  // –ê–≤—Ç–æ–ª–æ–≥–∏–Ω
  auth.onAuthStateChanged(user => {
    if (user && !currentUser) {
      currentUser = user;
      db.ref('users/' + user.uid).once('value').then(snap => {
        const data = snap.val();
        if (data) {
          document.getElementById('authScreen').style.display = 'none';
          document.getElementById('app').style.display = 'flex';
          document.getElementById('chatAvatar').textContent = data.avatar;
          loadMessages();
        }
      });
    }
  });
</script>
</body>
</html>
